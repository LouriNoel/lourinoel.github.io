<!DOCTYPE html>
<html>
	<head>
		<title>TP4 Multi</title>
		<meta charset="utf-8">
		<base href="../../index.html"/>
		<link rel="stylesheet" type="text/css" href="style.css">
		
		<style>
			#canvas {
				outline: black 3px solid;
				display: block;
				padding: 0px;
				margin: 0px auto;
			}
		</style>
		
		<script>
			class BoundingBox {
				constructor(x, y, w, h) {
					this.x = x;
					this.y = y;
					this.w = w;
					this.h = h;
				}
				
				copy(){
					return new BoundingBox(this.x, this.y, this.w, this.h);
				}
				
				// si cette bbox overlap avec celle passée en paramètre
				overlap(that){
					let checkX = Math.abs((this.x + this.w/2) - (that.x + that.w/2)) * 2 < (this.w + that.w);
					let checkY = Math.abs((this.y + this.h/2) - (that.y + that.h/2)) * 2 < (this.h + that.h);
					return checkX && checkY;
				}
			}
		
			class Spot {
				constructor(ctx, x, y, r, color) {
					this.ctx = ctx;
					this.x = x;
					this.y = y;
					this.r = r;
					this.color = color;
					
					let s = 2*this.r;
					this.bbox = new BoundingBox(0, 0, s, s);
					
					this.bbox.x = this.x - this.r;
					this.bbox.y = this.y - this.r;
				}
				
				setPosition(x, y){
					this.x = x;
					this.y = y;
					
					this.bbox.x = this.x - this.r;
					this.bbox.y = this.y - this.r;
				}
			
				draw(){
					ctx.fillStyle = this.color;
					ctx.beginPath();
						ctx.arc(this.x, this.y, this.r, 0, 2 * Math.PI);
					ctx.closePath();
					ctx.fill();
				}
			}
			
			var canvas;
			var ctx;
			
			const NB_WORKERS = 10;
			const SPOT_RADIUS = 30;
			var workers = [];
			var spots = [];
			
			function main(){
				canvas = document.getElementById('canvas');
				ctx = canvas.getContext('2d');
				
				if(!window.Worker){
					console.log("Your browser does not support web workers.");
					return;
				}
				
				for(let i=0 ; i<NB_WORKERS ; i++){
					spots.push(new Spot(ctx, -100, -100, SPOT_RADIUS, getRandomColor())); // initialement à l'extérieur du canvas
					
					const worker = new Worker("js/tp4/worker.js");
					workers.push(worker);
				
					worker.onmessage = handleWorkerMessage;

					worker.postMessage('{"header": "id", "id": ' + i + '}');
					worker.postMessage('{"header": "launch", "range": ' + canvas.width + '}');
				}
			}
			
			function getRandomColor(){
				let MAX = 240; // pas 255 afin de ne pas avoir un cercle blanc sur un fond blanc
				
				let r = Math.floor(MAX * Math.random());
				let g = Math.floor(MAX * Math.random());
				let b = Math.floor(MAX * Math.random());
				
				return "rgb(" + r + "," + g + "," + b + ")";
			}
			
			// traite le message reçu de la part de tous les workers
			function handleWorkerMessage(msg){
				let data = JSON.parse(msg.data);
				
				// zone qui sera à effacer : ancienne position du spot
				let bbox = spots[data.id].bbox.copy();
				
				// update
				spots[data.id].setPosition(data.x, data.y);
				
				// render
				render(bbox);
				
				// on dessine le spot à la nouvelle position si ce n'est pas déjà fait. (1)
				// (1) peut arriver si la nouvelle bbox overlap avec la précédente.
				if(!bbox.overlap(spots[data.id].bbox)){
					spots[data.id].draw();
				}
			}
			
			function render(bbox){
				ctx.fillStyle = "white";
				ctx.clearRect(bbox.x, bbox.y, bbox.w, bbox.h); // efface une partie du canvas
				
				spots.forEach(spot => {
					if(bbox.overlap(spot.bbox)){
						spot.draw(); // car a été (en partie) effacé
					}
				});
			}
		</script>
	</head>

	<body onload="main()">
		<header>
			<h1>Site de Louri</h1>
		</header>

		<nav class="flex-list">
			<ul>
				<li><a href="js/index_js.html">Javascript</a></li>
				<li><a href="python/index_python.html">Python</a></li>
				<li><a href="index.html">Accueil</a></li>
			</ul>
		 </nav>

		 <main>
			<article>
				<div class="article-body">
					<p>Avec plusieurs spots :</p>
					<canvas id="canvas" width="600" height="600"></canvas>
				</div>
			</article>
		</main>

		<footer>
			<p>©Copyright: All Rights Reserved</p>
		</footer>

	</body>
</html>